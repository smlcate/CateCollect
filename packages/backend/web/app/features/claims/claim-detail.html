<section class="claim-detail" ng-if="!vm.loading && vm.claim">
  <header class="bar">
    <div>
     <h2>Claim {{vm.claim.claim_number}} <small style="font-weight:400">({{vm.claim.reference_code || '—'}})</small></h2>
     <div class="muted">Carrier: <strong>{{vm.claim.carrier_name}}</strong> • Status: {{vm.claim.status}}</div>
   </div>
   <div>
     <label style="display:flex;align-items:center;gap:6px">
       <input type="checkbox" ng-checked="vm.claim.archived" ng-click="vm.setArchived(!vm.claim.archived)" />
       {{ vm.claim.archived ? 'Archived' : 'Archive' }}
     </label>
   </div>
    <a class="btn" href="#!/">
      ← Back
    </a>
  </header>
  <section>
    <h3>Notes</h3>
    <form ng-submit="vm.addNote()" style="display:flex;gap:8px;align-items:flex-start">
      <textarea ng-model="vm.newNote" rows="2" placeholder="Add a quick note…" style="flex:1"></textarea>
      <button type="submit">Add</button>
    </form>
    <ul class="notes">
      <li ng-repeat="n in vm.notes">
        <div class="muted">{{n.created_at | date:'short'}}</div>
        <div>{{n.note}}</div>
      </li>
    </ul>
  </section>

  <section>
    <h3>Activity</h3>
    <div ng-if="vm.eventsLoading">Loading activity…</div>
    <ul class="activity" ng-if="!vm.eventsLoading && vm.events.length">
      <li ng-repeat="ev in vm.events">
        <div class="muted">{{ev.created_at | date:'short'}}</div>
        <div>{{ vm.eventText(ev) }}</div>
        <div class="muted small" ng-if="ev.detail && (ev.detail.filename || ev.detail.types || ev.detail.original)">
          <span ng-if="ev.detail.filename">file: {{ev.detail.filename}}</span>
          <span ng-if="ev.detail.types && ev.detail.types.length">types: {{ev.detail.types.join(', ')}}</span>
          <span ng-if="ev.detail.original">original: {{ev.detail.original}}</span>
        </div>
      </li>
    </ul>
    <p class="muted" ng-if="!vm.eventsLoading && !vm.events.length">No activity yet.</p>
  </section>

  <div class="grid">
    <div>
      <h3>Required Documents</h3>
      <ul class="checklist" ng-if="vm.checklist">
        <li ng-repeat="req in vm.checklist.required">
          <span class="badge" ng-class="{'ok': vm.hasDoc(req), 'miss': !vm.hasDoc(req)}">
            {{ vm.hasDoc(req) ? '✅' : '❌' }}
          </span>
          <span>{{req}}</span>
        </li>
      </ul>
    </div>

    <div>
      <h3>Uploaded / Registered Docs</h3>
      <table class="table" ng-if="vm.documents.length">
        <thead><tr><th>Type</th><th>Filename</th><th>When</th></tr></thead>
        <tbody>
          <tr ng-repeat="d in vm.documents">
            <td>{{d.type}}</td>
            <td>{{d.filename}}</td>
            <td>{{d.uploaded_at | date:'short'}}</td>
          </tr>
        </tbody>
      </table>
      <p ng-if="!vm.documents.length" class="muted">No documents yet.</p>

      <h3 style="margin-top:16px">Upload a document</h3>
      <form ng-submit="vm.upload()" enctype="multipart/form-data" class="upload-form">
        <input list="docTypes" ng-model="vm.up.type" placeholder="e.g. estimate, photos, invoices" required />
        <datalist id="docTypes">
          <option value="estimate"></option>
          <option value="photos"></option>
          <option value="invoices"></option>
          <option value="supplement"></option>
          <option value="oem_docs"></option>
          <option value="pre_scan"></option>
          <option value="post_scan"></option>
        </datalist>
        <input type="file" id="fileInput" required />
        <button type="submit" ng-disabled="vm.upLoading">Upload</button>
        <span class="muted" ng-if="vm.upLoading && vm.upPct >= 0">Uploading {{vm.upPct}}%</span>
        <span class="err" ng-if="vm.upErr">{{vm.upErr}}</span>
      </form>
    </div>
  </div>
</section>

<section ng-if="vm.loading"><p>Loading…</p></section>

<style>
  .bar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:8px 0}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px}
  .checklist{list-style:none;padding:0;margin:0}
  .checklist li{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid #eee}
  .badge{display:inline-block;width:28px;text-align:center}
  .badge.ok{color:#16a34a}
  .badge.miss{color:#b91c1c}
  .muted{color:#6b7280}
  .err{color:#b91c1c;margin-left:8px}
  .btn{border:1px solid #111;padding:6px 10px;border-radius:6px;text-decoration:none;color:#111}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid #eee;padding:8px;text-align:left}
  .upload-form{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
  .upload-form input[type="file"]{max-width:280px}
  .notes{list-style:none;margin:8px 0 0;padding:0}
  .notes li{border-bottom:1px solid #eee;padding:8px 0}
  .activity{list-style:none;margin:8px 0 0;padding:0}
  .activity li{border-bottom:1px solid #eee;padding:8px 0}
  .small{font-size:12px}
</style>
